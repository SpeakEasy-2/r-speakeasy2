#!/usr/bin/env sh

ROOT=$(
    cd "$(dirname "$0")" || exit
    pwd
)

SE2="${ROOT}/src/se2"
IGRAPH="${SE2}/vendor/igraph"

# Only collects C files. If C++ needed, extend patterns.
collect_objs() {
    obj_path="$1"
    find "$obj_path" -name '*.c' | sed -n 's/\.c/.o/p' | tr '\n' ' '
}

# Attempt to piece-wise collect igraph source files to reduce hard to handle
# dependencies.
SE2_OBJS=$(collect_objs "${SE2}/src")

IGRAPH_OBJS="${IGRAPH}/src/core/interruption.o \
    ${IGRAPH}/src/core/vector.o \
    ${IGRAPH}/src/core/memory.o \
    ${IGRAPH}/src/core/indheap.o \
    ${IGRAPH}/src/core/matrix.o \
    ${IGRAPH}/src/core/vector_ptr.o \
    ${IGRAPH}/src/core/vector_list.o \
    ${IGRAPH}/src/core/printing.o \
    ${IGRAPH}/src/core/error.o \
    ${IGRAPH}/src/core/sparsemat.o \
    ${IGRAPH}/src/graph/type_indexededgelist.o \
    ${IGRAPH}/src/graph/iterators.o \
    ${IGRAPH}/src/graph/type_common.o \
    ${IGRAPH}/src/graph/caching.o \
    ${IGRAPH}/src/graph/attributes.o \
    ${IGRAPH}/src/internal/hacks.o \
    ${IGRAPH}/src/internal/qsort.o \
    ${IGRAPH}/src/internal/qsort_r.o \
    ${IGRAPH}/src/math/complex.o \
    ${IGRAPH}/src/math/utils.o \
    ${IGRAPH}/src/properties/degrees.o \
    ${IGRAPH}/src/constructors/basic_constructors.o \
    ${IGRAPH}/src/community/community_misc.o \
    ${IGRAPH}/src/linalg/arpack.o"

IGRAPH_RAND_OBJS=$(collect_objs "${IGRAPH}/src/random")
CS_OBJS=$(collect_objs "${IGRAPH}/vendor/cs")

cat <<_EOF_ >"${ROOT}/src/Makevars"
# Generated by configure; do not edit.
PKG_CFLAGS = \$(C_VISIBILITY) \$(CPICFLAGS)
PKG_CPPFLAGS = -DUSING_R -I${ROOT}/src/include -I${SE2}/include -I${IGRAPH}/include -I${IGRAPH}/vendor -I${IGRAPH}/src
PKG_LIBS = \$(LAPACK_LIBS) \$(BLAS_LIBS) -larpack
OBJECTS = speakeasyR.o ${SE2_OBJS} ${IGRAPH_OBJS} ${IGRAPH_RAND_OBJS} ${CS_OBJS}
_EOF_
